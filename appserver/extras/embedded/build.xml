<?xml version="1.0" encoding="iso-8859-1"?>
<!--

    Copyright (c) 2010, 2020 Oracle and/or its affiliates. All rights reserved.

    This program and the accompanying materials are made available under the
    terms of the Eclipse Public License v. 2.0, which is available at
    http://www.eclipse.org/legal/epl-2.0.

    This Source Code may also be made available under the following Secondary
    Licenses when the conditions for such availability set forth in the
    Eclipse Public License v. 2.0 are satisfied: GNU General Public License,
    version 2 with the GNU Classpath Exception, which is available at
    https://www.gnu.org/software/classpath/license.html.

    SPDX-License-Identifier: EPL-2.0 OR GPL-2.0 WITH Classpath-exception-2.0

-->

<project name="glassfish-embedded-all" default="create.distribution" basedir=".">
    <property name="rootdir" value="target"/>
    <property name="zipdir" value="${rootdir}/packager_zips"/>
    <property name="jardir" value="${rootdir}/packager_jars"/>
    <property name="gfdir" value="${jardir}/${install.dir.name}/glassfish"/>
    <property name="modulesdir" value="${gfdir}/modules"/>
    <property name="filedir" value="${rootdir}/packager_files"/>

    <target name="create.distribution">
        <antcall target="makeJarDir"/>
        <antcall target="removeJarsNotNeeded"/>
        <antcall target="addDtds"/>
        <antcall target="addRars"/>
        <antcall target="addEjbTimer"/>
        <antcall target="rejar"/>
        <attachArtifact file="${finaljar}"/>
    </target>

    <target name="makeJarDir">
        <echo message="creating jar directory..."/>
        <copy todir="${jardir}">
            <fileset dir="${zipdir}">
                <include name="*.jar"/>
            </fileset>
        </copy>

        <!-- The packager files are zips with jars inside -->
        <unzip dest="${jardir}">
            <fileset dir="${zipdir}">
                <include name="*.zip"/>
                <exclude name="mq**.zip"/>
                <exclude name="derby**.zip"/>
            </fileset>
        </unzip>

        <unzip dest="${jardir}/javadb">
            <fileset dir="${zipdir}">
                <include name="derby**.zip"/>
            </fileset>
            <patternset>
                <include name="**/lib/**"/>
                <include name="**/bin/**"/>
            </patternset>
        </unzip>

        <mkdir dir="${rootdir}/temp" />
    </target>

    <target name="removeJarsNotNeeded">
        <delete verbose="true" failonerror="true">
            <fileset dir="${jardir}" includes="ant-**.jar" />
            <fileset dir="${jardir}" includes="weld-se-shaded**.jar" />
        </delete>
    </target>


    <target name="addDtds">
        <echo message="adding dtds"/>
        <jar jarfile="${jardir}/dtds.jar" basedir="${jardir}/glassfish/lib" includes="dtds/**/*"/>
        <jar jarfile="${jardir}/schemas.jar" basedir="${jardir}/glassfish/lib" includes="schemas/**/*"/>
        <jar jarfile="${jardir}/nucleus-dtds.jar" basedir="${jardir}/lib" includes="dtds/**/*"/>
        <jar jarfile="${jardir}/nucleus-schemas.jar" basedir="${jardir}/lib" includes="schemas/**/*"/>
    </target>

    <target name="rejar">
        <echo message="rejarring and processing metadata..."/>
        <taskdef name="rejar" classname="org.jvnet.maven.plugin.antrun.RejarTask" />

        <defaultexcludes add="META-INF/**.RSA"/>
        <defaultexcludes add="META-INF/**.inf"/>
        <defaultexcludes add="META-INF/**.SF"/>

        <!-- level 9 - on modern machines the CPU is so fast that the difference in time is low. -->
        <rejar destfile="${finaljar}" duplicate="preserve" level="9" >
            <manifest>
                <attribute name="Bundle-SymbolicName" value="${bundlename}"/>
                <attribute name="Main-Class" value="com.sun.enterprise.glassfish.bootstrap.UberMain"/>
            </manifest>
            <zipgroupfileset dir="${jardir}" includes="**/*.jar"/>
            <fileset dir="${rootdir}/temp" includes="*.rar, *.war"/>
        </rejar>
    </target>

    <target name="addRars">
        <echo message="adding rars"/>
        <jar jarfile="${jardir}/__cp_jdbc_ra.rar" basedir="${jardir}/glassfish" includes="lib/install/applications/__cp_jdbc_ra/**/*"/>
        <jar jarfile="${jardir}/__ds_jdbc_ra.rar" basedir="${jardir}/glassfish" includes="lib/install/applications/__ds_jdbc_ra/**/*"/>
        <jar jarfile="${jardir}/__dm_jdbc_ra.rar" basedir="${jardir}/glassfish" includes="lib/install/applications/__dm_jdbc_ra/**/*"/>
        <jar jarfile="${jardir}/__xa_jdbc_ra.rar" basedir="${jardir}/glassfish" includes="lib/install/applications/__xa_jdbc_ra/**/*"/>
        <copy todir="${rootdir}/temp">
            <fileset dir="${jardir}">
                <include name="*.rar"/>
            </fileset>
        </copy>
    </target>
</project>
